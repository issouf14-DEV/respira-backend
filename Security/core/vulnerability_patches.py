# Patch de securite anti-vulnerabilites CVE #52, #53, #54
# Desactivation complete .netrc et durcissement SSL

import requests
import ssl
import os

# PATCH CVE #52 - Vulnerabilite .netrc
# Force la desactivation complete de .netrc
def patch_requests_netrc():
    # Monkey patch global pour requests
    original_get_netrc_auth = getattr(requests.sessions, 'get_netrc_auth', None)
    if original_get_netrc_auth:
        requests.sessions.get_netrc_auth = lambda url, raise_errors=False: None
    
    # Patch au niveau auth
    if hasattr(requests, 'auth'):
        requests.auth.get_netrc_auth = lambda url, raise_errors=False: None
    
    # Force trust_env=False sur toutes les sessions
    original_session_init = requests.Session.__init__
    def secure_session_init(self, *args, **kwargs):
        original_session_init(self, *args, **kwargs)
        self.trust_env = False
    requests.Session.__init__ = secure_session_init

# PATCH CVE #54 - Vulnerabilite OpenSSL cryptography
# Configuration SSL ultra-securisee
def patch_ssl_cryptography():
    # Context SSL securise
    def create_ultra_secure_context():
        context = ssl.create_default_context()
        context.options |= ssl.OP_NO_SSLv2
        context.options |= ssl.OP_NO_SSLv3
        context.options |= ssl.OP_NO_TLSv1
        context.options |= ssl.OP_NO_TLSv1_1
        context.minimum_version = ssl.TLSVersion.TLSv1_2
        context.set_ciphers('ECDHE+AESGCM:ECDHE+CHACHA20:DHE+AESGCM:!aNULL:!MD5:!DSS')
        return context
    
    # Remplacer le context par defaut
    ssl._create_default_https_context = create_ultra_secure_context

# PATCH CVE #55, #56, #57, #58 - Vulnerabilites urllib3 critiques
def patch_urllib3_vulnerabilities():
    try:
        import urllib3
        from urllib3.poolmanager import PoolManager
        from urllib3.util.retry import Retry
        
        # Patch CVE #55, #56 - Desactiver redirections automatiques
        original_poolmanager_init = PoolManager.__init__
        def secure_poolmanager_init(self, *args, **kwargs):
            # Force desactivation redirections
            kwargs['retries'] = False
            kwargs['redirect'] = False
            original_poolmanager_init(self, *args, **kwargs)
            # Force configuration securisee
            self.retries = Retry(redirect=0, total=3)
        
        PoolManager.__init__ = secure_poolmanager_init
        
        # Patch CVE #57, #58 - Limiter decompression et streaming
        if hasattr(urllib3, 'response'):
            original_read = urllib3.response.HTTPResponse.read
            def secure_read(self, amt=None, decode_content=None, cache_content=False):
                # Limiter taille lecture pour eviter decompression bomb
                if amt is None or amt > 10485760:  # Max 10MB
                    amt = 10485760
                return original_read(self, amt, decode_content, cache_content)
            
            urllib3.response.HTTPResponse.read = secure_read
        
        # Configuration globale securisee
        urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
        
        print("SECURITE: Patch urllib3 CVE #55,#56,#57,#58 applique")
        
    except Exception as e:
        print(f"ERREUR patch urllib3: {e}")

# Application des patches
patch_requests_netrc()
patch_ssl_cryptography()
patch_urllib3_vulnerabilities()

print("SECURITE: Tous patches CVE appliques")